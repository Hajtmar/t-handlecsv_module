\usemodule[handlecsv]

%http://wiki.contextgarden.net/System_Macros/Loops_and_Recursion



% Při použití \doloopuntil, \doloopwhile 
\def\tableactionexp{\expanded{\bTR\bTD\cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}}
\def\tabactionexp{\expanded{\bTR \bTD \cA \eTD \bTD \Jmeno \eTD \bTD \Prijmeni \eTD \eTR}}
\def\tableaction{\bTR\bTD\cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}
\def\tabaction{\bTD\cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD}
\def\XX{\expanded{\bTR\bTD XX exp \cA - \Jmeno\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}}
\def\YY{\bTR\bTD YY noexp \cA - \Jmeno / \Prijmeni\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}
\def\AA{\bTR\bTD\ AA \Jmeno\ \Prijmeni\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}
\def\BB{\bTR\bTD\ BB \cA - \Jmeno \eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}
\def\CC{\bTR\bTD\ CC \Prijmeni\ \Jmeno / \Prijmeni\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}
\def\DD{\bTR\bTD\ DD \cA - \Nick\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}

\def\notableaction{\cA, \Jmeno\ \Prijmeni\par}
\def\notableactionexp{\expanded{\cA, \Jmeno\ \Prijmeni\par}}
\def\XXX{\Id XX exp \cA - \Jmeno\ \Jmeno\ \Prijmeni\par}


\starttext
000000000000000000000
\def\bfilehook{\bTABLE[split=yes]}
\def\blinehook{\bTR}
\def\elinehook{\eTR}
\def\efilehook{\eTABLE}
\setheader
\opencsvfile{lisajdb1.csv}
%\def\lineaction{\tableaction}

TEST 1

% U doloopfromto je třeba dávat \expanded{}!!!!!
%\doloopfromto{2}{5}{\expanded{\bTD Ahoj\eTD\bTD \Jmeno\ \Prijmeni\eTD}} %%% OK

%\doloopfromto{1}{5}{\notableactionexp} %%% OK

% 	\resethooks

%\let\blinehook\relax%
%\let\elinehook\relax%
%\let\bfilehook\relax%
%\let\efilehook\relax%
    
TEST 2
%\def\lineaction{\expanded{\bTR\bTD\cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}}
\def\lineaction{\expanded{\bTD\cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD}}

%\bTABLE
%\doloopaction
\doloopaction{\tabactionexp} 
%\eTABLE

\stoptext
%\def\lineaction{\tabactionexp}
%\bTABLE
%\doloopaction 
%\eTABLE


\page 

TEST 3

\def\tableactionexpa{\expanded{\bTR\bTD\cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD\eTR}}
\opencsvfile{lisajdb.csv}

\bTABLE
\doloopfromto{18}{25}{\tableactionexpa} %%% OK 
\eTABLE

%\doloopaction{18}{29}{tableactionexpa} %%% OK

%\bTABLE
\doloopaction%\expanded{\bTD NL - \numline\ \cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD}}

\doloopaction{xxx}%\expanded{\bTD NL - \numline\ \cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD}}

\doloopaction{xxx}{xxx}%\expanded{\bTD NL - \numline\ \cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD}}

\doloopaction{xxx}{xxx}{xxx}%\expanded{\bTD NL - \numline\ \cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD}}

%\eTABLE

%\bTABLE
%\doloopaction{\tabactionexp}
%\eTABLE

%\doloopaction{\notableactionexp}

%\doloopaction{\notableactionexp}{4}

%\doloopaction{\notableactionexp}{5}{7}

\stoptext


TEST 3

\opencsvfile{lisajdb.csv}
\doloopwhile{\Jmeno}{Tomáš}{\expanded{\bTD Ahoj\eTD\bTD \Jmeno\ \Prijmeni\eTD}}


TEST 4

\doloopuntil{\Id}{11}{\expanded{\bTD Nazdar\ \Id\ - \eTD\bTD \Jmeno\ \Prijmeni\eTD}}

TEST 5


\opencsvfile{lisajdb2.csv}
\doloopforall{\expanded{\bTD\Jmeno\ Těpic\ \Id\ - \eTD\bTD \Jmeno\ \Prijmeni\eTD\bTD \Id\ \eTD}}

TEST 6

\opencsvfile{lisajdb2.csv}
%\def\lineaction{\bTD\cA\eTD\bTD\Jmeno\eTD\bTD\Prijmeni\eTD}

%\filelineaction

%\filelineaction{lisajdb1.csv}

%\filelineaction{lisajdb2.csv}{4}

%\filelineaction{lisajdb.csv}{14}{18}

\doloopfromto{1}{5}{\tabactionexp}


\resethooks


\page
TEST 7

\setheader
\opencsvfile{lisajdb2.csv}
\def\lineaction{\tableactionexp}

\type{\filelineaction}
	
\bTABLE
%\filelineaction % OK pro \def\lineaction{\tableaction}
\eTABLE


\setheader
\opencsvfile{lisajdb2.csv}
\def\lineaction{\tableaction}

\type{\filelineaction{lisajdb1.csv}}	

\bTABLE
%\filelineaction{lisajdb1.csv} % OK pro \def\lineaction{\tableaction} 
\eTABLE

\type{\filelineaction{lisajdb1.csv}{3}}

\bTABLE
%\filelineaction{lisajdb1.csv}{3} % OK pro \def\lineaction{\tableaction}
\eTABLE

\opencsvfile{lisajdb2.csv}

\type{\filelineaction{lisajdb2.csv}{3}{5}}

\bTABLE
%\filelineaction{lisajdb2.csv}{3}{5} 
\eTABLE



\page 

TEST 8

\def\bfilehook{\bTABLE[split=yes]}
\def\blinehook{\bTR}
\def\elinehook{\eTR}
\def\efilehook{\eTABLE}
\setheader
\opencsvfile{lisajdb1.csv}
\def\lineaction{\tabaction}

%\filelineaction

%\filelineaction{lisajdb1.csv}

%\filelineaction{lisajdb.csv}{3}

%\filelineaction{lisajdb2.csv}{3}{5}


\page

33333333333333333333333.
\setheader
\opencsvfile{lisajdb1.csv}

\type{\doloopforall{\XX}}

\bTABLE
%  process \lineaction for all rows OK
\doloopforall{\XX} % OK 
\eTABLE


\page
44444444444444444444444.

\setheader
\opencsvfile{lisajdb2.csv}

\type{\doloopaction{\lineaction}}

\bTABLE
\doloopaction{\lineaction}
\eTABLE

\type{\doloopaction{\YY}{5}}

\bTABLE
\doloopaction{\YY}{5}
\eTABLE


\type{\doloopaction{\YY}{5}{8} }

\bTABLE
\doloopaction{\YY}{5}{8}
\eTABLE

\page

555555555555555555555555

\type{\filelineaction}

\def\lineaction{\tableaction}

\bTABLE
\filelineaction
\eTABLE

\type{\filelineaction{lisajdb1.csv}}

\def\lineaction{\tableaction} 
\bTABLE
\filelineaction{lisajdb1.csv}
\eTABLE


 
\type{\filelineaction{lisajdb1.csv}{3}}
 
\def\lineaction{\tableaction} 
\bTABLE
%\opencsvfile{lisajdb1.csv}
%\doloopaction{\YY}{3}%
\filelineaction{lisajdb1.csv}{3}
%\filelineaction
\eTABLE


\type{\filelineaction{lisajdb1.csv}{3}{6}}

\bTABLE
\filelineaction{lisajdb1.csv}{3}{6}
%\filelineaction{lisajdb1.csv}{3}{6}
\eTABLE

\page



\type{\doloopforall{\XXX}}

\setheader
\opencsvfile{lisajdb1.csv}
\doloopforall{\XXX}

\page

\type{\doloopfromto{5}{7}{\notableaction} }

\opencsvfile{lisajdb1.csv}
\doloopfromto{5}{7}{\notableaction}


\page
 
\def\lineaction{AAAA} 
\doloopaction
\doloopaction{XXX}
\doloopaction{\notableaction}{5}
\doloopaction{ZZZ}{2}{4}

\page
\def\lineaction{\notableaction}
\doloopaction{\YY}{5} 

\setfiletoscan{lisajdb1.csv}
\opencsvfile
\filelineaction

\page

\opencsvfile{lisajdb1.csv}
\bTABLE
\doloopaction{\CC}{5}{8}
\eTABLE

\page

YYYYYYYYYYYYYYYYYYYYYYYY 11111111

\setfiletoscan{lisajdb.csv}
\bTABLE
\doloopwhile{\Jmeno}{Tomáš}{\AA}
\eTABLE

aaaaaaaa

\bTABLE
\doloopuntil{\Jmeno}{Jan}{\YY}
\eTABLE


bbbbbbbbbbb

\bTABLE
\opencsvfile{lisajdb1.csv}
\dorecurse{5}{\XX\nextrow} % OK
\eTABLE

cccccccccccccc

\bTABLE
\opencsvfile{lisajdb1.csv}
\doloop{\ifnotEOF\XX\nextrow\else\exitloop\fi}
\eTABLE


\page

\opencsvfile{lisajdb1.csv}
\doloopaction{\numline AHOJ\par}{5}{6}

\opencsvfile{lisajdb1.csv}
\doloopaction{\numline AHOJ\par}{5} %ošetřit počet průběhů

\opencsvfile{lisajdb1.csv}
\doloopaction{\numline AHOJ\par}{4}{7}

\opencsvfile{lisajdb1.csv}
\dorecurse{5}{\lineaction\nextrow} %OK


\opencsvfile{lisajdb1.csv}
\doloop{\lineaction\nextrow\ifnum\numline>7\exitloop\fi} %OK

\opencsvfile{lisajdb1.csv}
\doloop{\ifEOF\exitloop\else\lineaction\nextrow\fi} %OK

\opencsvfile{lisajdb1.csv}
\doloop{\lineaction\nextrow \if\Id3 \exitloop \fi} %OK

\opencsvfile{lisajdb1.csv}
\doloopwhile{\Jmeno}{Slávek}{\lineaction}

\opencsvfile{lisajdb1.csv}
\doloopuntil{\Jmeno}{Markéta}{\lineaction}

\opencsvfile{lisajdb1.csv}
\doloopuntil{x}{y}{\lineaction} % pro všechny záznamy....

\page

\opencsvfile{lisajdb1.csv}
podminka A AND B

\doloop{
\ifnum\Id>5
	\ifnum\Id<8 Delej \Id-\XXX
	\fi
\fi
\ifEOF\exitloop\else\nextrow\ifEOF\exitloop\fi\fi
}

\page


\opencsvfile{lisajdb1.csv}
Podminka A OR B

\def\AorB{\XXX}

\doloop{
\ifnum\Id=1 \AorB %
\else\ifnum\Id>4 \AorB \fi
\fi
\ifEOF\exitloop\else\nextrow\ifEOF\exitloop\fi\fi
}


\page
\opencsvfile{lisajdb1.csv}
\doloop{\recurselevel - \lineaction\nextrow\ifnum\recurselevel>5 \exitloop \fi} %OK


\opencsvfile{lisajdb1.csv}
\doloop{\ifEOF\exitloop\else\lineaction\nextrow\fi} %OK

\opencsvfile{lisajdb1.csv}
\doloop{\ifnotEOF\lineaction\nextrow\else\exitloop\fi} %OK

\opencsvfile{lisajdb1.csv}
\doloopforall{aaa\par}

\stoptext 
